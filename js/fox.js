async function makeFile(fs, fileName, fileType, content) {
  await new Promise((res) => {
    fs.root.getFile(
      fileName,
      {},
      (fileEntry) => {
        fileEntry.remove(res);
      },
      res
    );
  });
  return await new Promise((res) => {
    fs.root.getFile(fileName, { create: true }, (fileEntry) => {
      fileEntry.createWriter((fileWriter) => {
        fileWriter.write(new Blob([content], { type: fileType }));
        res(fileEntry.toURL());
      });
    });
  });
}

async function onInitFs(fs) {
  let htmlFile = await makeFile(fs, "index.html", "text/html", `<!DOCTYPE html><html lang="en"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width,initial-scale=1"><title>FoxLauncher</title><script src="zip.js"></script><script src="./payload.js"></script><link rel="stylesheet" href="payload.css"></head><body><div class="content"><div class="border"><table><tr><td class="infotd"><h1>FoxLauncher</h1><div class="textcontent">Made by<a href="https://foxmoss.com/personal/">foxmoss</a>from<a href="mailto:foxmoss@mediaology.com">foxmoss@mediaology.com</a>. Read the documentation at<a href="https://foxmoss.com/foxlauncher">foxmoss.com/foxlauncher</a></div><div><label class="resourcesFileUpload upload zipinst"><input type="file" id="resourcesFileInput"> Upload .flr</label><button id="flr" class="zipinst">Load the zip.flr file!</button></div><h3>Permissions:</h3><ul id="permList"></ul><script>cspInline=!0</script></td><td class="seperatorContainer"><div class="seperator"></div></td><td><h2>Game Bookmarks:</h2><ul id="fileList"></ul><label class="zipFileUpload upload zip" disabled="disabled"><input type="file" id="zipFileInput" class="zip" disabled="disabled"> Upload .flz</label><button id="flz" class="zip" disabled="disabled">Load the .flz file!</button></td></tr></table></div></div></body></html>`);
  await makeFile(fs, "payload.js", "text/js", `window.addEventListener("DOMContentLoaded",e=>{document.getElementById("flr").addEventListener("click",uploadResource),document.getElementById("flz").addEventListener("click",uploadZip),checkFileExists("zip.js").then(e=>{e&&(document.querySelectorAll(".zipinst").forEach(e=>{e.remove()}),document.querySelectorAll(".zip").forEach(e=>{e.removeAttribute("disabled")}))}),scanFiles(),scanPerms(),void 0!=chrome.tabs&&document.body.addEventListener("click",function(e){e.target&&"A"==e.target.nodeName&&chrome.tabs.create({url:e.target.href})})});var cspInline=!1,specialPerms=[];async function uploadResource(){let e=document.getElementById("resourcesFileInput"),t=e.files[0];makeFile("zip.js",await t.text()),alert("Reload this tab.")}function checkFileExists(e){return new Promise((t,i)=>{window.webkitRequestFileSystem(window.TEMPORARY,10485760,function(i){i.root.getFile(e,{create:!1},function(e){t(!0)},function(e){t(!1)})},function(e){i(e)})})}function grabIndices(e){let t=[];for(file in e.files)file.includes("index.html")&&t.push(e.files[file]);return t}function uploadZip(){let e=document.getElementById("zipFileInput"),t=e.files[0];if(!t){alert("Please select a zip file.");return}let i=new FileReader;i.onload=async function(e){let t=new JSZip,i={},n=!1;await t.loadAsync(e.target.result).then(async function(e){let t=document.getElementById("fileList"),a=grabIndices(e);for(let l in e.files)if(e.files[l].dir)await makeDir(e.files[l].name.split("/")[0]),await makeDir(e.files[l].name);else{let r=await e.files[l].async("blob");e.files[l].name.includes("config.flc")&&(n=checkConf(await e.files[l].async("text"))),i[e.files[l].name]=r}if(!await n){alert("Permissions are probably wrong!");return}for(blob in i)await makeFileBlob(blob,i[blob]);for(index in a){let s=document.createElement("li"),c=document.createElement("a"),o=document.createTextNode(a[index].name.replace("/index.html",""));c.href="filesystem:"+window.location.origin+"/temporary/"+a[index].name,c.appendChild(o),s.appendChild(c),t.appendChild(s)}})},i.readAsArrayBuffer(t)}function checkPerms(e){return new Promise(t=>{e.forEach(e=>{specialPerms.includes(e.textContent)||t(!1)}),t(!0)})}async function checkConf(e){return await checkPerms(new DOMParser().parseFromString(e,"text/xml").querySelectorAll("SETTINGS > PERMISSIONS > PERM"))}function getAllPerms(){return new Promise(e=>{chrome.permissions.getAll(t=>e(t.permissions))})}async function scanPerms(){let e=document.getElementById("permList");try{(specialPerms=await getAllPerms()).push("boykisser")}catch(t){specialPerms=["boykisser"]}cspInline&&specialPerms.push("cspinline"),specialPerms.forEach(t=>{let i=document.createElement("li"),n=document.createTextNode(t);i.appendChild(n),e.appendChild(i)})}async function makeFileBlob(e,t){let i=await new Promise(e=>{window.webkitRequestFileSystem(window.TEMPORARY,10485760,e)});return await new Promise(t=>{i.root.getFile(e,{},e=>{e.remove(t)},t)}),await new Promise(n=>{i.root.getFile(e,{create:!0},e=>{e.createWriter(i=>{i.write(t),n(e.toURL())})})})}async function makeFile(e,t){let i=await new Promise(e=>{window.webkitRequestFileSystem(window.TEMPORARY,10485760,e)});return await new Promise(t=>{i.root.getFile(e,{},e=>{e.remove(t)},t)}),await new Promise(n=>{i.root.getFile(e,{create:!0},e=>{e.createWriter(i=>{i.write(new Blob([t])),n(e.toURL())})})})}async function makeDir(e){(await new Promise(e=>{window.webkitRequestFileSystem(window.TEMPORARY,10485760,e)})).root.getDirectory(e,{create:!0},e=>{})}async function scanFiles(){let e=await new Promise(e=>{window.webkitRequestFileSystem(window.TEMPORARY,10485760,e)}),t=document.getElementById("fileList"),i=e.root.createReader(),n=document.createElement("ul");t.appendChild(n),i.readEntries(e=>{e.forEach(e=>{if(e.isDirectory){let i=document.createElement("li"),n=document.createElement("a"),a=document.createTextNode(e.name);n.href="filesystem:"+window.location.origin+"/temporary/"+e.name+"/index.html",n.appendChild(a),i.appendChild(n),t.appendChild(i)}})})}`);
  await makeFile(fs, "payload.css", "text/css", `:root{--bg1:#413652;--bg2:#6f577e;--ct1:#575f7e;--ct2:#62778c;--txt:#d4beb8;--lnk:#90c0a0;--old:#c090a7}body,html{width:100%;height:100%;background:repeating-conic-gradient(var(--bg1) 0 25%,var(--bg2) 0 50%) 50%/10vw 10vw;margin:0;padding:0;animation:4s linear infinite BgDrift}@keyframes BgDrift{0%{background-position:0 0}100%{background-position:10vw 10vw}}.content{margin-left:20%;margin-right:20%;padding-top:10%}.border{box-shadow:0 0 20px 15px var(--bg1);background:linear-gradient(0deg,var(--ct1) 50%,var(--ct2) 100%);font-family:Verdana,sans-serif;padding:10px;color:var(--txt);border-radius:20px;height:50vh}.upload,button{border:1px solid var(--lnk);display:inline-block;padding:10px;cursor:pointer}.seperator,table{height:100%}input[type=file]{display:none}.upload{margin-bottom:10px}.upload:hover,button:hover{background-color:color-mix(in srgb,var(--lnk),transparent 50%)}.upload[disabled],button[disabled]{opacity:.6;cursor:default}button{all:unset;background-color:var(--lnk);float:right;color:var(--bg1)}.textcontent{padding-bottom:20px}a{color:var(--lnk)}a:visited{color:var(--old)}td{vertical-align:top}.infotd{width:40%;padding:10px}h2{margin-top:30px}.seperatorContainer{width:.8%}.seperator{border-radius:10px;background:linear-gradient(0deg,transparent 30%,var(--txt) 40%,var(--txt) 60%,transparent 70%);width:100%}`);
}

webkitRequestFileSystem(window.TEMPORARY, 1024*1024, onInitFs);
